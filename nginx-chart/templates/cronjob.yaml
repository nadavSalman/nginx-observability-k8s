{{- if .Values.trafficGenerator.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "nginx-chart.fullname" . }}-traffic-generator
  labels:
    {{- include "nginx-chart.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.trafficGenerator.schedule | quote }}
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: traffic-generator
        spec:
          restartPolicy: OnFailure
          containers:
            - name: traffic-generator
              image: curlimages/curl:latest
              command:
                - /bin/sh
                - -c
                - |
                  #!/bin/sh
                  
                  SERVICE="http://{{ include "nginx-chart.fullname" . }}"
                  
                  echo "Starting traffic generation to $SERVICE"
                  
                  # Generate 100 requests with mixed proxied and direct responses
                  TOTAL_REQUESTS=100
                  echo "Generating $TOTAL_REQUESTS requests (mix of proxied and direct)"
                  
                  for i in $(seq 1 $TOTAL_REQUESTS); do
                    # Cycle through different request types (20 of each)
                    REQUEST_TYPE=$(($i % 5))
                    
                    case $REQUEST_TYPE in
                      0)
                        # Proxied GET request to httpbin
                        ENDPOINT="/api/get"
                        echo "Request $i: $SERVICE$ENDPOINT (proxied to httpbin, expecting 200)"
                        ;;
                      1)
                        # 404 Not Found
                        ENDPOINT="/error/notfound-$RANDOM"
                        echo "Request $i: $SERVICE$ENDPOINT (expecting 404)"
                        ;;
                      2)
                        # 500 Internal Server Error
                        ENDPOINT="/api/error-$RANDOM"
                        echo "Request $i: $SERVICE$ENDPOINT (expecting 500)"
                        ;;
                      3)
                        # Proxied delay request (1-2 seconds)
                        DELAY=$((1 + RANDOM % 2))
                        ENDPOINT="/api/delay-$DELAY"
                        echo "Request $i: $SERVICE$ENDPOINT (proxied with ${DELAY}s delay, expecting 200)"
                        ;;
                      4)
                        # 503 Service Unavailable
                        ENDPOINT="/api/unavailable-$RANDOM"
                        echo "Request $i: $SERVICE$ENDPOINT (expecting 503)"
                        ;;
                    esac
                    
                    # Make request and capture status code
                    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE$ENDPOINT" 2>/dev/null || echo "000")
                    echo "  Status: $HTTP_CODE"
                    
                    # Small delay between requests
                    sleep 0.1
                  done
                  
                  echo "Traffic generation complete"
{{- end }}

