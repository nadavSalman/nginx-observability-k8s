replicaCount: 3

# Service type label for microservice architecture identification
serviceType: "api-gateway"  # Options: api-gateway, frontend, backend-proxy, static-server, etc.

image:
  repository: nginx
  pullPolicy: IfNotPresent
  tag: "latest"

exporter:
  image:
    repository: nginx/nginx-prometheus-exporter
    tag: "0.10.0"
  port: 9113
  resources:
    limits:
      memory: 128Mi
      cpu: 500m
    requests:
      memory: 64Mi
      cpu: 100m

service:
  type: ClusterIP
  port: 80
  metricsPort: 9113

nginx:
  config: |
    map $uri $generalized_path {
        ~^/api/unavailable- /api/unavailable-*;
        ~^/api/delay-       /api/delay-*;
        ~^/api/status/      /api/status/*;
        ~^/error/notfound-  /error/notfound-*;
        default             $uri;
    }

    log_format custom_format '$remote_addr - $remote_user [$time_local] '
      '"$request_method $generalized_path $server_protocol" $status $body_bytes_sent '
      '"$http_referer" "$http_user_agent" '
      '$upstream_response_time $hostname {{ .Values.serviceType }}';

    upstream httpbin {
        server nginx-server-nginx-chart-httpbin:80;
    }

    server {
        listen 80;
        server_name localhost;

        access_log /var/log/nginx/access.log custom_format;

        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
        }

        # Proxy to httpbin for general GET requests
        location /api/get {
            proxy_pass http://httpbin/get;
        }

        # Proxy POST requests to httpbin
        location /api/post {
            proxy_pass http://httpbin/post;
        }

        # Proxy PUT requests to httpbin
        location /api/put {
            proxy_pass http://httpbin/put;
        }

        # Proxy DELETE requests to httpbin
        location /api/delete {
            proxy_pass http://httpbin/delete;
        }

        # Proxy PATCH requests to httpbin
        location /api/patch {
            proxy_pass http://httpbin/patch;
        }

        # Proxy to httpbin status endpoints for generating specific HTTP errors
        location ~ ^/api/status/(\d+)$ {
            proxy_pass http://httpbin/status/$1;
            proxy_read_timeout 30s;
        }

        # Proxy with delays (1-3 seconds) for latency testing
        location ~ ^/api/delay-(\d+)$ {
            proxy_pass http://httpbin/delay/$1;
            proxy_read_timeout 30s;
        }

        # Simulate 500 errors for /api/error-* endpoints
        location ~ ^/api/error- {
            return 500 "Internal Server Error\n";
        }

        # Simulate 503 errors for /api/unavailable-* endpoints
        location ~ ^/api/unavailable- {
            return 503 "Service Unavailable\n";
        }

        # Simulate 502 errors for /api/badgateway-* endpoints
        location ~ ^/api/badgateway- {
            return 502 "Bad Gateway\n";
        }

        location /nginx_status {
            stub_status on;
            access_log off;
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }

prometheus:
  scrape: true
  port: 9113

trafficGenerator:
  enabled: true
  schedule: "* * * * *"  # Every minute for higher request rate

dashboard:
  enabled: true

resources: {}

nodeSelector: {}

tolerations: []

affinity: {}
